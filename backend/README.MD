# ğŸ”§ Rally Stage Generator - Backend

API REST pour la gÃ©nÃ©ration de spÃ©ciales de rallye.

## ğŸ“‹ Description

Le backend est une API Node.js/Express qui :
- GÃ©ocode les villes franÃ§aises via Nominatim
- RÃ©cupÃ¨re les routes depuis OpenStreetMap via Overpass API
- Filtre les routes adaptÃ©es au rallye
- GÃ©nÃ¨re un tracÃ© optimisÃ© avec dÃ©tection des intersections

## ğŸ—ï¸ Structure du projet
```
backend/
â”œâ”€â”€ index.js                    # Point d'entrÃ©e Express
â”œâ”€â”€ routes/
â”‚   â””â”€â”€ generate.js             # Route /api/generate
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ geocoder.js             # Service de gÃ©ocodage Nominatim
â”‚   â”œâ”€â”€ overpass.js             # Service Overpass API
â”‚   â”œâ”€â”€ geojsonConverter.js     # Conversion OSM â†’ GeoJSON
â”‚   â”œâ”€â”€ rallyFilter.js          # Filtrage des routes rallye
â”‚   â””â”€â”€ specialeGenerator.js    # GÃ©nÃ©ration de spÃ©ciale
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ geometry.js             # Fonctions gÃ©omÃ©triques
â”œâ”€â”€ package.json
â””â”€â”€ README.md
```

## ğŸš€ Installation
```bash
cd backend
npm install
```

## âš™ï¸ Configuration

| Variable | DÃ©faut | Description |
|----------|--------|-------------|
| `PORT` | 4000 | Port du serveur |

## ğŸƒ DÃ©marrage
```bash
# Mode dÃ©veloppement
npm start

# Ou avec nodemon (si installÃ©)
npm run dev
```

Le serveur dÃ©marre sur http://localhost:4000

## ğŸ“¡ API Endpoints

### `POST /api/generate`

GÃ©nÃ¨re une spÃ©ciale de rallye.

**Body (JSON)**
```json
{
  "place": "Gap",
  "postal": "05000",
  "radiusKm": 10
}
```

**RÃ©ponse**
```json
{
  "ok": true,
  "center": { "lat": 44.5594, "lon": 6.0789 },
  "radiusMeters": 10000,
  "stats": { "waysCount": 150, "totalKm": 89.5 },
  "geojson": { "type": "FeatureCollection", "features": [...] },
  "intersections": [7, 23, 41, 64, ...],
  "speciales": [[...]]
}
```

### `GET /api/ping`

Health check du serveur.

**RÃ©ponse**
```json
{
  "ok": true,
  "version": "backend v4"
}
```

## ğŸ” Services

### geocoder.js
GÃ©ocode une ville franÃ§aise via l'API Nominatim d'OpenStreetMap.

### overpass.js
Interroge l'API Overpass pour rÃ©cupÃ©rer les routes dans un rayon donnÃ©.

### rallyFilter.js
Filtre les routes pour ne garder que celles adaptÃ©es au rallye :
- Types autorisÃ©s : track, unclassified, road, secondary, tertiary, residential
- Surfaces autorisÃ©es : asphalt, gravel, dirt, etc.
- Exclusions : autoroutes, chemins piÃ©tons, zones commerciales, etc.

### specialeGenerator.js
GÃ©nÃ¨re le tracÃ© de la spÃ©ciale en utilisant un algorithme de graphe et dÃ©tecte les intersections.

## ğŸ“¦ DÃ©pendances

- `express` - Framework web
- `axios` - Client HTTP
- `cors` - Middleware CORS
- `osmtogeojson` - Conversion OSM â†’ GeoJSON
- `@turf/turf` - Calculs gÃ©ospatiaux
- `graphlib` - Algorithmes de graphe

## ğŸ› DÃ©bogage

Les logs dans la console affichent :
- Les requÃªtes Overpass envoyÃ©es
- Le nombre d'Ã©lÃ©ments reÃ§us
- Les intersections dÃ©tectÃ©es (indices et nombre de voisins)
